import subprocess
import xml.etree.ElementTree as ET
import json
import os
from datetime import datetime

BASELINE_FILE = "baseline.json"


# ----------------------------
# Run Nmap and return open ports
# ----------------------------
def run_scan(target: str):
    xml_file = f"{target}_scope_scan.xml"
    command = ["nmap", "-Pn", "-sS", "-p", "20-1024", target, "-oX", xml_file]
    subprocess.run(command)

    open_ports = []
    tree = ET.parse(xml_file)
    root = tree.getroot()

    for host in root.findall("host"):
        for port in host.findall("ports/port"):
            state_el = port.find("state")
            if state_el is None:
                continue

            state = state_el.get("state")
            if state == "open":
                port_id = port.get("portid")
                if port_id:
                    open_ports.append(int(port_id))

    return sorted(list(set(open_ports)))


# ----------------------------
# Save baseline (always new format)
# ----------------------------
def save_baseline(data: dict):
    with open(BASELINE_FILE, "w") as f:
        json.dump(data, f, indent=2)


# ----------------------------
# Load baseline + auto-migrate old format
# ----------------------------
def load_baseline():
    # No file -> new multi-host format
    if not os.path.exists(BASELINE_FILE):
        return {"hosts": {}}

    with open(BASELINE_FILE, "r") as f:
        data = json.load(f)

    # ✅ Case 1: already new format
    if isinstance(data, dict) and "hosts" in data and isinstance(data["hosts"], dict):
        return data

    # ✅ Case 2: old format detected -> migrate
    # Old format example: {"target": "...", "open_ports": [...]}
    if isinstance(data, dict) and "target" in data and "open_ports" in data:
        migrated = {
            "hosts": {
                data["target"]: {
                    "open_ports": sorted(list(set(data["open_ports"]))),
                    "last_baseline_update": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                }
            }
        }
        save_baseline(migrated)
        print("[*] Migrated old baseline.json to new multi-host format.")
        return migrated

    # ✅ Case 3: unknown format -> reset safely
    print("[!] baseline.json format not recognized. Creating a new baseline structure.")
    fresh = {"hosts": {}}
    save_baseline(fresh)
    return fresh


# ----------------------------
# Compare current ports with baseline ports
# ----------------------------
def compare_ports(old_ports, new_ports):
    old_set = set(old_ports)
    new_set = set(new_ports)

    opened = sorted(list(new_set - old_set))
    closed = sorted(list(old_set - new_set))
    unchanged = sorted(list(old_set & new_set))

    print("\n=== Scope Validation Report ===")
    print("Newly Opened Ports:", opened)
    print("Closed Ports:", closed)
    print("Unchanged Ports:", unchanged)


# ----------------------------
# Main
# ----------------------------
if __name__ == "__main__":
    target = input("Enter target (domain/IP): ").strip()
    mode = input("Mode (baseline/compare): ").strip().lower()

    current_ports = run_scan(target)
    baseline_data = load_baseline()

    # Ensure structure exists
    if "hosts" not in baseline_data:
        baseline_data["hosts"] = {}

    # If host not in baseline, add it automatically
    if target not in baseline_data["hosts"]:
        baseline_data["hosts"][target] = {
            "open_ports": current_ports,
            "last_baseline_update": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        save_baseline(baseline_data)
        print(f"[+] New host added to baseline: {target}")
        print(f"[+] Saved open ports: {current_ports}")
        raise SystemExit

    # Host exists in baseline
    old_ports = baseline_data["hosts"][target].get("open_ports", [])

    if mode == "baseline":
        # Update baseline for this host
        baseline_data["hosts"][target] = {
            "open_ports": current_ports,
            "last_baseline_update": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        save_baseline(baseline_data)
        print(f"[+] Baseline updated for {target}")
        print(f"[+] Saved open ports: {current_ports}")

    elif mode == "compare":
        # Compare current scan vs baseline
        last_update = baseline_data["hosts"][target].get("last_baseline_update", "unknown")
        print(f"[*] Comparing current scan vs baseline for {target}")
        print(f"[*] Baseline last updated: {last_update}")
        compare_ports(old_ports, current_ports)

    else:
        print("[!] Invalid mode. Use baseline or compare.")
